---
interface Props {
  title: string;
  description: string;
  canonical?: string;
  ogImage?: string;
  schema?: object;
  faqs?: Array<{ question: string; answer: string }>;
  alternates?: Array<{ hreflang: string; href: string }>;
  breadcrumbs?: Array<{ name: string; url: string }>;
}

const {
  title,
  description,
  canonical = Astro.url.href,
  ogImage = '/og-default.png',
  schema,
  faqs,
  alternates = [],
  breadcrumbs
} = Astro.props;

const siteUrl = 'https://gpacalc.app';
const siteName = 'GPACalc';
const fullTitle = `${title} | ${siteName}`;
const siteOrigin = new URL(siteUrl).origin;

function normalizeCanonical(input: string) {
  try {
    const url = new URL(input, siteOrigin);
    const normalized = new URL(siteOrigin);
    let path = url.pathname.replace(/index\.html$/i, '');
    if (!path.endsWith('/')) path = `${path}/`;
    normalized.pathname = path;
    return normalized.toString();
  } catch {
    return `${siteOrigin}/`;
  }
}

const canonicalUrl = normalizeCanonical(canonical);
const normalizedAlternates = alternates
  .filter((item) => item?.hreflang && item?.href)
  .map((item) => ({
    hreflang: item.hreflang.trim(),
    href: normalizeCanonical(item.href)
  }));

// Make OG image absolute URL
const absoluteOgImage = ogImage.startsWith('http') ? ogImage : `${siteUrl}${ogImage}`;

// Inject url into schema if it has @type
const enrichedSchema = schema ? { ...schema, url: canonicalUrl } : null;
const calculatorSchema = enrichedSchema ? JSON.stringify(enrichedSchema) : null;

// FAQ Schema
const faqSchema = faqs?.length ? JSON.stringify({
  "@context": "https://schema.org",
  "@type": "FAQPage",
  "mainEntity": faqs.map(faq => ({
    "@type": "Question",
    "name": faq.question,
    "acceptedAnswer": {
      "@type": "Answer",
      "text": faq.answer
    }
  }))
}) : null;

// BreadcrumbList Schema
const breadcrumbSchema = breadcrumbs?.length ? JSON.stringify({
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": breadcrumbs.map((item, i) => ({
    "@type": "ListItem",
    "position": i + 1,
    "name": item.name,
    "item": item.url
  }))
}) : null;
---

<!-- Primary Meta Tags -->
<title>{fullTitle}</title>
<meta name="title" content={fullTitle} />
<meta name="description" content={description} />
<link rel="canonical" href={canonicalUrl} />
{normalizedAlternates.map((item) => (
  <link rel="alternate" hreflang={item.hreflang} href={item.href} />
))}

<!-- Open Graph / Facebook -->
<meta property="og:type" content="website" />
<meta property="og:url" content={canonicalUrl} />
<meta property="og:title" content={fullTitle} />
<meta property="og:description" content={description} />
<meta property="og:image" content={absoluteOgImage} />
<meta property="og:site_name" content={siteName} />

<!-- Twitter -->
<meta property="twitter:card" content="summary_large_image" />
<meta property="twitter:url" content={canonicalUrl} />
<meta property="twitter:title" content={fullTitle} />
<meta property="twitter:description" content={description} />
<meta property="twitter:image" content={absoluteOgImage} />

<!-- Schema.org -->
{calculatorSchema && (
  <script type="application/ld+json" set:html={calculatorSchema} />
)}

{faqSchema && (
  <script type="application/ld+json" set:html={faqSchema} />
)}

{breadcrumbSchema && (
  <script type="application/ld+json" set:html={breadcrumbSchema} />
)}

<!-- Organization Schema -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "GPACalc",
  "url": "https://gpacalc.app",
  "logo": "https://gpacalc.app/favicon.ico",
  "sameAs": [
    "https://x.com/yidabuilds",
    "https://github.com/Yida-Dev/gpa-calculator"
  ]
}
</script>
